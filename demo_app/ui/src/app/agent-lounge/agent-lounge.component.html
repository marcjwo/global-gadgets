<mat-sidenav-container class="lounge-container">
  <mat-sidenav mode="side" opened class="agent-sidebar">
    <mat-nav-list>
      <div mat-subheader>Select Agent</div>
      <a mat-list-item *ngFor="let agent of agents" (click)="selectAgent(agent)"
        [class.active-agent]="selectedAgent?.id === agent.id">
        <mat-icon matListItemIcon [style.color]="agent.color">{{agent.avatar}}</mat-icon>
        <span matListItemTitle>{{agent.name}}</span>
        <span matListItemLine class="agent-desc">{{agent.description}}</span>
      </a>
    </mat-nav-list>
  </mat-sidenav>

  <mat-sidenav-content class="chat-content">
    <div class="chat-header" *ngIf="selectedAgent">
      <mat-icon [style.color]="selectedAgent.color">{{selectedAgent.avatar}}</mat-icon>
      <h2>{{selectedAgent.name}}</h2>
    </div>

    <div class="chat-history" #scrollContainer>
      <div *ngFor="let msg of currentMessages" class="message-bubble"
        [ngClass]="{'user-message': msg.sender === 'user', 'agent-message': msg.sender === 'agent'}"
        [style.border-left-color]="msg.sender === 'agent' ? selectedAgent?.color : 'transparent'">

        <div class="message-header">
          <span class="sender-name">{{ msg.sender === 'user' ? 'You' : selectedAgent?.name }}</span>
          <span class="timestamp">{{ msg.timestamp | date:'shortTime' }}</span>
        </div>

        <div class="message-content">
          <app-markdown-viewer [data]="msg.text" *ngIf="msg.sender === 'agent'"></app-markdown-viewer>
          <span *ngIf="msg.sender === 'user'">{{ msg.text }}</span>
        </div>
      </div>

      <div *ngIf="isLoading" class="loading-indicator">
        <mat-icon class="spin">sync</mat-icon> Thinking...
      </div>
    </div>

    <div class="input-area">
      <mat-form-field appearance="outline" class="full-width no-subscript">
        <mat-label>Ask {{selectedAgent?.name}}...</mat-label>
        <input matInput [(ngModel)]="userInput" (keyup.enter)="sendMessage()" [disabled]="isLoading" autocomplete="off">
        <button mat-icon-button matSuffix (click)="sendMessage()" [disabled]="!userInput.trim() || isLoading">
          <mat-icon>send</mat-icon>
        </button>
      </mat-form-field>
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>